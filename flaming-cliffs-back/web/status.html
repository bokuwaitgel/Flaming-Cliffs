<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Live Status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
      .rotate-180 {
        transform: rotate(180deg);
      }

      .moon-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #eee;
        border: 2px solid #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        margin: auto;
      }
      /* Small inline spinner used for live loading states in visitor cards */
      .loader {
        width: 22px;
        height: 22px;
        border: 3px solid rgba(0,0,0,0.08);
        border-top-color: rgba(0,0,0,0.45);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="bg-white text-black font-sans min-h-screen">
    <header
      class="bg-gradient-to-b from-[#2c1c12] to-[#000000] text-white shadow-md border-b border-black"
    >
      <div
        class="flex items-center justify-between px-4 sm:px-10 md:px-20 lg:px-40 py-4"
      >
        <!-- Logo & Title -->
        <a href="index.html" class="flex flex-row items-center gap-2">
          <img
            src="img/baynzag logo.png"
            alt="Flaming Cliffs Logo"
            class="h-10 w-auto"
          />
          <span class="text-lg font-bold text-white">Flaming Cliffs</span>
        </a>

        <!-- Desktop/Tablet Navigation -->
        <nav
          class="hidden xl:flex gap-4 lg:gap-8 text-sm font-semibold text-white"
        >
          <a href="index.html" class="hover:text-yellow-500">HOME</a>
          <a href="about.html" class="hover:text-yellow-500">ABOUT</a>
          <a href="learn_detail.html" class="hover:text-yellow-500"
            >FOSSILS & DISCOVERIES</a
          >
          <a href="status.html" class="hover:text-yellow-500"
            >LIVE STATS FROM VISITORS</a
          >
          <a href="#" class="hover:text-yellow-500">PRESERVATION</a>
          <a href="photo_gallery.html" class="hover:text-yellow-500">GALLERY</a>
          <a href="#contact" class="hover:text-yellow-500">CONTACT</a>
          <a href="login.html" class="hover:text-yellow-500">LOGIN</a>
        </nav>

        <!-- Language Selector -->
        <div class="hidden xl:block">
          <select
            class="bg-[#2c2c2c] border border-gray-600 text-white text-sm px-2 py-1 rounded"
          >
            <option value="en">EN</option>
            <option value="mn">MN</option>
          </select>
        </div>

        <!-- Mobile Menu Button -->
        <div class="xl:hidden">
          <button
            id="menu-toggle"
            class="text-white focus:outline-none focus:ring-2 focus:ring-yellow-400"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
        </div>
      </div>
      <!-- Mobile Menu -->
      <div id="mobile-menu" class="hidden xl:hidden px-4 pb-4 space-y-2">
        <a href="index.html" class="block hover:text-yellow-500">HOME</a>
        <a href="about.html" class="block hover:text-yellow-500">ABOUT</a>
        <a href="learn_detail.html" class="block hover:text-yellow-500"
          >FOSSILS & DISCOVERIES</a
        >
        <a href="status.html" class="block hover:text-yellow-500"
          >LIVE STATS FROM VISITORS</a
        >
        <a href="#" class="block hover:text-yellow-500">PRESERVATION</a>
        <a href="photo_gallery.html" class="block hover:text-yellow-500"
          >GALLERY</a
        >
        <a href="#contact" class="block hover:text-yellow-500">CONTACT</a>
        <a href="login.html" class="block hover:text-yellow-500">LOGIN</a>
        <select
          class="bg-[#2c2c2c] border border-gray-600 text-white text-sm px-2 py-1 rounded w-full mt-2"
        >
          <option value="en">EN</option>
          <option value="mn">MN</option>
        </select>
      </div>
    </header>

    <div id="home" class="w-full">
      <!-- Background Image -->
      <div class="relative">
        <img
          src="img/live stats top desktop.jpg"
          alt="Flaming Cliffs"
          class="object-cover z-0 w-full h-64 md:h-auto"
        />
        <img
          src="img/divider.png"
          alt="Upper Divider"
          class="absolute left-0 bottom-0 w-full pointer-events-none z-10"
        />
        <div
          class="absolute top-[55%] left-[23%] transform -translate-x-1/2 -translate-y-1/2 text-white text-center px-4 md:top-1/2 md:left-[15%] md:text-left md:-translate-x-0"
        >
          <h1
            class="text-2xl leading-[1.5] font-semibold tracking-tight md:text-6xl"
          >
            <span class="block">Live Stats <br />for Visitors </span>
          </h1>
        </div>
      </div>
    </div>

    <div class="mt-0">
      <div class="max-w-6xl mx-auto py-6 px-4">
        <!-- Title -->
        <h2
          class="text-2xl md:text-3xl font-bold text-center mb-6 text-white bg-orange-500 rounded-xl px-8 py-3 w-full mx-auto"
        >
          Visitors by Tour Operator
        </h2>

        <!-- Tabs -->
        <div
          class="flex flex-wrap space-x-4 md:space-x-6 mt-6 text-sm font-semibold border-b justify-center"
          id="tabs"
        >
          <button
            class="tab-button text-orange-500 text-xl md:text-2xl border-b-2 border-orange-500 pb-2"
          >
            Today
          </button>
          <button class="tab-button text-gray-400 text-xl md:text-2xl pb-2">
            This week
          </button>
          <button class="tab-button text-gray-400 text-xl md:text-2xl pb-2">
            This year
          </button>
        </div>

        <!-- Chart Section -->
        <div class="mt-0 relative overflow-x-auto max-w-6xl mx-auto py-6">
          <!-- Grid Lines -->
          <div
            class="absolute top-0 left-0 right-0 bottom-0 pointer-events-none z-0"
          >
            <div class="flex h-full justify-between px-2">
              <!-- 6 dashed vertical lines -->
              <div class="h-full border-l border-dashed border-gray-300"></div>
              <div class="h-full border-l border-dashed border-gray-300"></div>
              <div class="h-full border-l border-dashed border-gray-300"></div>
              <div class="h-full border-l border-dashed border-gray-300"></div>
              <div class="h-full border-l border-dashed border-gray-300"></div>
              <div class="h-full border-l border-dashed border-gray-300"></div>
            </div>
          </div>

          <!-- Bar Chart -->
          <div id="chart" class="relative z-10 space-y-4"></div>
        </div>

        <!-- Bottom Axis -->
        <div class="relative mt-0 h-4">
          <div class="absolute left-0 w-full h-px bg-gray-300"></div>
          <div class="flex justify-between text-xs text-gray-500 mt-1 pl-4">
            <span>0</span>
            <span>100</span>
            <span>200</span>
            <span>300</span>
            <span>400</span>
            <span>500</span>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-0 md:mt-32">
      <div class="py-6 px-4">
        <div class="max-w-6xl mx-auto relative">
          <!-- Orange Circle -->
          <div
            class="absolute inset-0 flex justify-center items-center pointer-events-none"
          >
            <div
              class="hidden md:block w-[250px] h-[250px] md:w-[400px] md:h-[400px] border-[6px] border-orange-400 rounded-full"
            ></div>
          </div>

          <!-- Visitor Cards -->
          <div
            class="relative grid grid-cols-1 sm:grid-cols-2 gap-4 justify-items-center"
          >
            <!-- Visitors Today -->
            <div
              class="bg-white rounded-lg shadow-lg flex items-center gap-4 p-4 max-w-sm w-full"
              data-period="today"
              role="button"
              tabindex="0"
            >
              <img
                src="img/live stats/Property 1=coming soon.png"
                alt="Visitors Today"
                class="w-20 h-20"
              />
              <div>
                <p class="text-black font-semibold text-lg">Visitors Today</p>
                  <p class="text-black font-semibold text-4xl"><span id="visitorsToday">0</span></p>
              </div>
            </div>

            <!-- Visitors This Week -->
            <div
              class="bg-white rounded-lg shadow-lg flex items-center gap-4 p-4 max-w-sm w-full"
              data-period="week"
              role="button"
              tabindex="0"
            >
              <img
                src="img/live stats/Property 1=medeelel-1.png"
                alt="Visitors This Week"
                class="w-20 h-20"
              />
              <div>
                <p class="text-black font-semibold text-lg">
                  Visitors This Week
                </p>
                <p class="text-black font-semibold text-4xl"><span id="visitorsWeek">0</span></p>
              </div>
            </div>

            <!-- Visitors This Month -->
            <div
              class="bg-white rounded-lg shadow-lg flex items-center gap-4 p-4 max-w-sm w-full"
              data-period="month"
              role="button"
              tabindex="0"
            >
              <img
                src="img/Component_66-removebg-preview.png"
                alt="Visitors This Month"
                class="w-16 h-16"
              />
              <div>
                <p class="text-black font-semibold text-lg">
                  Visitors This Month
                </p>
                <p class="text-black font-semibold text-4xl"><span id="visitorsMonth">0</span></p>
              </div>
            </div>

            <!-- Visitors This Year -->
            <div
              class="bg-white rounded-lg shadow-lg flex items-center gap-4 p-4 max-w-sm w-full"
              data-period="year"
              role="button"
              tabindex="0"
            >
              <img
                src="img/live stats/Property 1=medeelel.png"
                alt="Visitors This Year"
                class="w-20 h-20"
              />
              <div>
                <p class="text-black font-semibold text-lg">
                  Visitors This Year
                </p>
                <p class="text-black font-semibold text-4xl"><span id="visitorsYear">0</span></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-0 md:mt-32">
      <div class="max-w-6xl mx-auto py-6 space-y-6 px-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Visitors by Top Countries -->
          <div
            class="bg-white rounded-2xl shadow p-6 flex flex-col items-center justify-center"
          >
            <h2 class="text-xl md:text-3xl font-bold text-center mb-6">
              Visitors by Top Countries
            </h2>
            <canvas id="countryChart" class="w-full h-auto"></canvas>
          </div>

          <!-- Vehicle Types -->
          <div
            class="bg-white rounded-2xl shadow p-6 flex flex-col items-center justify-center"
          >
            <h2 class="text-xl md:text-3xl font-bold text-center mb-6">
              Vehicle Types
            </h2>
            <canvas id="vehicleChart" class="w-full h-auto"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-0 md:mt-32">
      <div
        class="flex flex-col lg:flex-row flex-nowrap gap-8 justify-center max-w-6xl p-4 sm:p-8 mx-auto"
      >
        <!-- Left Chart Card -->
        <div class="w-full lg:w-1/2 bg-white rounded-2xl p-6 shadow-md">
          <h2 class="text-xl md:text-3xl font-bold text-center mb-6">
            Monthly Guides and Drivers
          </h2>

          <div class="flex flex-col sm:flex-row justify-around gap-8">
            <!-- This Month -->
            <div class="flex flex-col items-center">
              <p class="text-xl font-normal mb-2">This Month</p>
              <div class="relative w-40 h-40 sm:w-48 sm:h-48">
                <canvas id="chart1" class="rotate-180"></canvas>
                <div
                  class="absolute inset-0 flex flex-col items-center justify-center"
                >
                  <span id="driverGuideTotal" class="text-xl font-semibold">800</span>
                  <div class="flex gap-2 text-xs mt-1">
                    <div class="flex items-center space-x-1 text-orange-500">
                      <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                      <span id="driverCountValue" class="text-sm font-semibold">600</span>
                    </div>
                    <div class="flex items-center space-x-1 text-blue-600">
                      <span class="w-2 h-2 rounded-full bg-blue-600"></span>
                      <span id="guideCountValue" class="text-sm font-semibold">200</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Legend -->
          <div
            class="flex justify-center gap-6 mt-6 text-sm text-gray-700 font-medium"
          >
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-orange-500"></span>
              <span class="text-base">Drivers</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-blue-500"></span>
              <span class="text-base">Guides</span>
            </div>
          </div>
        </div>

        <!-- Right Chart Card -->
        <div class="w-full lg:w-1/2 bg-white rounded-xl p-6 shadow-md">
          <h2 class="text-xl md:text-3xl font-bold text-center mb-6">
            Visitors by Tour Operator
          </h2>
          <canvas id="barChart" class="w-full h-auto"></canvas>
        </div>
      </div>
    </div>

    <div class="mt-3 md:mt-32">
      <div class="max-w-6xl mx-auto bg-white p-4 rounded-3xl shadow-md px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">
          Daily Visitor Trend
        </h2>

        <canvas id="visitorChart" class="w-full h-auto"></canvas>
      </div>
    </div>

    <!-- <div class="mt-3 md:mt-32">
      <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-8 px-4">
        <h2 class="text-2xl md:text-3xl font-semibold text-gray-800 mb-6">
          Peak Visitor Hours
        </h2>
        <canvas id="peakVisitorChart" class="w-full h-96"></canvas>
      </div>
    </div>

    <div class="mt-3 md:mt-32">
      <div class="max-w-6xl mx-auto bg-white p-6 rounded-3xl shadow px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">
          Visitor–Moon Phase Correlation
        </h2>

        <canvas id="moonChart" class="w-full h-96"></canvas>
      </div>
    </div> -->

    <div class="bg-[#1a130f] py-4 mt-3 md:mt-32">
      <div class="flex items-center gap-4 max-w-6xl mx-auto py-6 px-4">
        <!-- Icon -->
        <img
          src="img/baynzag logo.png"
          alt="Flaming Cliffs Icon"
          class="w-24 h-24 object-cover"
        />

        <!-- Text -->
        <div>
          <h1 class="text-white text-xl md:text-2xl">
            Flaming Cliffs ( Bayanzag )
          </h1>
          <p class="text-white text-lg md:text-xl mt-2">
            Discover Mongolia's Legendary Dinosaur Site
          </p>
        </div>
      </div>

      <!-- Divider line -->
      <div class="border-t border-[#3f3932] mt-2 max-w-6xl mx-auto"></div>
    </div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Country Statistics -->
    <script>
      let currentData = [];
      let maxValue = 500; // Default max value for chart scaling

      // API Base URL
      const API_BASE_URL = 'http://localhost:3000/api';

      // Function to fetch country statistics from backend
      async function fetchCountryStats(period = 'all') {
        try {
          const response = await fetch(`${API_BASE_URL}/country-stats?period=${period}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error fetching country statistics:', error);
          // Return fallback data if API fails
          return [
            { country: "South Korea", code: "kr", value: 321 },
            { country: "Russia", code: "ru", value: 243 },
            { country: "China", code: "cn", value: 228 },
            { country: "Kazakhstan", code: "kz", value: 190 },
            { country: "Japan", code: "jp", value: 170 },
            { country: "USA", code: "us", value: 160 },
            { country: "Germany", code: "de", value: 150 },
            { country: "France", code: "fr", value: 140 },
            { country: "UK", code: "gb", value: 135 },
            { country: "Australia", code: "au", value: 120 },
            { country: "Canada", code: "ca", value: 110 },
            { country: "Italy", code: "it", value: 85 },
            { country: "Poland", code: "pl", value: 60 },
            { country: "Turkey", code: "tr", value: 45 },
            { country: "Switzerland", code: "ch", value: 40 },
          ];
        }
      }

      // Function to render the chart
      function renderChart(data) {
        const chart = document.getElementById("chart");
        chart.innerHTML = ''; // Clear existing chart
        
        // Update max value based on actual data
        maxValue = Math.max(...data.map(item => item.value), 100);
        
        data.forEach((item) => {
          const bar = document.createElement("div");
          bar.className = "flex items-center space-x-2";

          const label = document.createElement("div");
          label.className = "w-40 flex items-center space-x-2";
          label.innerHTML = `
            <img src="https://flagcdn.com/w40/${item.code}.png" alt="${item.country} flag" class="w-6 h-4 object-cover rounded-sm shadow" />
            <span>${item.country}</span>
          `;

          const barWrapper = document.createElement("div");
          barWrapper.className = "flex items-center w-full";

          const barInner = document.createElement("div");
          barInner.className = "bg-orange-500 h-5 rounded-r";
          barInner.style.width = `${(item.value / maxValue) * 100}%`;

          const valueLabel = document.createElement("div");
          valueLabel.className =
            "ml-2 text-xs font-bold bg-[#541616] text-white px-2 py-0.5 rounded";
          valueLabel.textContent = item.value;

          barWrapper.appendChild(barInner);
          barWrapper.appendChild(valueLabel);

          bar.appendChild(label);
          bar.appendChild(barWrapper);
          chart.appendChild(bar);
        });
      }

      // Function to fetch general statistics and populate visitor cards
      async function fetchAndPopulateStatistics(period = 'all') {
        try {
          // show loading state on visitor cards
          setVisitorCardsLoading(true);

          const resp = await fetch(`${API_BASE_URL}/statistics?period=${period}`);
          if (!resp.ok) throw new Error('Statistics fetch failed');
          const stats = await resp.json();

          // statistics endpoint returns totals - map them to card values
          // For 'today' we expect totals for the period; for 'all' we use 'today' fallback
          const totalTourists = stats.totalTourists || 0;
          const totalRevenue = stats.totalRevenue || 0;
          const totalGuides = stats.totalGuides || 0;
          const totalDrivers = stats.totalDrivers || 0;

          // Populate visitor cards (today/week/month/year) by calling visitor-stats for different ranges
          const [todayStats, weekStats, monthStats, yearStats] = await Promise.all([
            fetch(`${API_BASE_URL}/visitor-stats?period=today`).then(r => r.ok ? r.json() : {}),
            fetch(`${API_BASE_URL}/visitor-stats?period=week`).then(r => r.ok ? r.json() : {}),
            fetch(`${API_BASE_URL}/visitor-stats?period=month`).then(r => r.ok ? r.json() : {}),
            fetch(`${API_BASE_URL}/visitor-stats?period=year`).then(r => r.ok ? r.json() : {})
          ]);
        
          document.getElementById('visitorsToday').textContent = todayStats.totalVisitors || 0;
          document.getElementById('visitorsWeek').textContent = weekStats.totalVisitors || 0;
          document.getElementById('visitorsMonth').textContent = monthStats.totalVisitors || 0;
          document.getElementById('visitorsYear').textContent = yearStats.totalVisitors || 0;

          return stats;
        } catch (error) {
          console.error('Error fetching and populating statistics:', error);
          return null;
        } finally {
          // hide loading state
          setVisitorCardsLoading(false);
        }
      }

      // Utility to toggle loading state on visitor cards
      function setVisitorCardsLoading(isLoading) {
        const cardEls = document.querySelectorAll('[data-period]');
        cardEls.forEach((card) => {
          const valueSpan = card.querySelector('span[id^="visitors"]');
          // create or remove loader
          let loader = card.querySelector('.loader');
          if (isLoading) {
            if (!loader) {
              loader = document.createElement('span');
              loader.className = 'loader ml-2';
              if (valueSpan && valueSpan.parentNode) {
                valueSpan.parentNode.appendChild(loader);
                valueSpan.style.opacity = '0.25';
              }
            }
          } else {
            if (loader) loader.remove();
            if (valueSpan) valueSpan.style.opacity = '';
          }
        });
      }

      // Function to load data for selected period
      async function loadDataForPeriod(period) {
        try {
          // Load country statistics
          const data = await fetchCountryStats(period);
          currentData = data;
          renderChart(data);

          // Load combined visitor-by-country-and-vehicle data and render charts
          const visitorByCountryAndVehicle = await fetchVisitorByCountryAndVehicle(period);
          updateCountryAndVehicleCharts(visitorByCountryAndVehicle);

          // Update daily visitor time series
          await updateVisitorChart(period);

          // Populate visitor cards and general statistics
          await fetchAndPopulateStatistics(period);

          // If visitor-by-country-and-vehicle includes driver/guide counts, use it to update the monthly donuts
          let skipDonutUpdate = false;
          if (visitorByCountryAndVehicle && (visitorByCountryAndVehicle.drivers != null || visitorByCountryAndVehicle.guides != null || visitorByCountryAndVehicle.driverGuide)) {
            const dg = visitorByCountryAndVehicle.driverGuide || { drivers: visitorByCountryAndVehicle.drivers, guides: visitorByCountryAndVehicle.guides };
            const drivers = dg.drivers || 0;
            const guides = dg.guides || 0;

            // update donut charts directly using existing helper
            chart1Instance = createChart('chart1', [drivers, guides], chart1Instance);
            const scaleFactor = 7.5;
            chart2Instance = createChart('chart2', [Math.round(drivers * scaleFactor), Math.round(guides * scaleFactor)], chart2Instance);

            // update small numeric placeholders inside the donuts if they exist
            const driversEl = document.getElementById('driverCountValue');
            const guidesEl = document.getElementById('guideCountValue');
            if (driversEl) driversEl.textContent = String(drivers);
            if (guidesEl) guidesEl.textContent = String(guides);

            // update scaled placeholders
            const driversElScaled = document.getElementById('driverCountValueScaled');
            const guidesElScaled = document.getElementById('guideCountValueScaled');
            if (driversElScaled) driversElScaled.textContent = String(Math.round(drivers * scaleFactor));
            if (guidesElScaled) guidesElScaled.textContent = String(Math.round(guides * scaleFactor));

            // update totals
            const totalEl = document.getElementById('driverGuideTotal');
            const totalScaledEl = document.getElementById('driverGuideTotalScaled');
            if (totalEl) totalEl.textContent = String(drivers + guides);
            if (totalScaledEl) totalScaledEl.textContent = String(Math.round((drivers + guides) * scaleFactor));

            skipDonutUpdate = true;
          }

          // Update donut charts (unless we already updated them from the visitor-by-country-and-vehicle payload)
          if (!skipDonutUpdate) {
            // prefer monthly aggregation for the donut visuals when user requests month
            if (period === 'month') await updateDonutCharts('month');
            else await updateDonutCharts(period);
          }

          // Update bar chart
          await updateBarChart(period);

          // Update peak visitor chart
          await updatePeakVisitorChart(period);

        } catch (error) {
          console.error('Error loading data:', error);
        }
      }

      // Fetch visitor-by-country-and-vehicle endpoint
      async function fetchVisitorByCountryAndVehicle(period = 'week') {
        try {
          const resp = await fetch(`${API_BASE_URL}/visitor-by-country-and-vehicle?period=${period}`);
          if (!resp.ok) throw new Error('visitor-by-country-and-vehicle fetch failed');
          return await resp.json();
        } catch (error) {
          console.error('Error fetching visitor-by-country-and-vehicle:', error);
          // fallback structure
          return {
            tourists: {
              China: 228,
              Russia: 243,
              "South Korea": 321,
              Japan: 170,
              USA: 160
            },
            vehicleTypes: {
              "4WD SUV": 25,
              Minibus: 30,
              Bus: 20,
              Crossover: 15,
              "Compact car": 5,
              Motorcycle: 5
            }
          };
        }
      }

      // Chart instances for dynamic update
      let countryChartInstance = null;
      let vehicleChartInstance = null;

  // Update countryChart and vehicleChart using visitor-by-country-and-vehicle data
      function updateCountryAndVehicleCharts(data) {
        if (!data) return;

        // Prepare country dataset (top 8)
        const countryEntries = Object.entries(data.tourists || {}).sort((a,b) => b[1] - a[1]);
        const topCountries = countryEntries.slice(0, 8);
        const countryLabelsDynamic = topCountries.map(c => c[0]);
        const countryValues = topCountries.map(c => c[1]);
        const countryColors = ["#F97316","#EF4444","#FBBF24","#22D3EE","#0EA5E9","#A855F7","#EC4899","#60A5FA"];

        const countryCanvas = document.getElementById('countryChart');
        if (countryCanvas) {
          // destroy Chart.js instance if attached directly to this canvas
          const existingCountryChart = Chart.getChart(countryCanvas);
          if (existingCountryChart) existingCountryChart.destroy();
          if (countryChartInstance) countryChartInstance.destroy();

          // ensure a legend container exists beneath the canvas
          let countryLegend = countryCanvas.nextElementSibling;
          if (!countryLegend || !countryLegend.classList || !countryLegend.classList.contains('chart-legend')) {
            countryLegend = document.createElement('div');
            countryLegend.className = 'chart-legend mt-4 text-sm flex flex-wrap justify-center gap-3';
            countryCanvas.parentNode.insertBefore(countryLegend, countryCanvas.nextSibling);
          }

          countryChartInstance = new Chart(countryCanvas.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: countryLabelsDynamic,
              datasets: [{ data: countryValues, backgroundColor: countryColors.slice(0, countryLabelsDynamic.length), borderWidth: 0 }]
            },
            options: {
              cutout: '75%',
              animation: { duration: 800, easing: 'easeInOutCubic' },
              plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed}` } },
                datalabels: {
                  color: '#000',
                  formatter: (value, ctx) => {
                    const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                    const pct = Math.round((value / sum) * 100);
                    return pct + '%';
                  },
                  anchor: 'center',
                  align: 'center',
                  font: { weight: 'bold', size: 12 }
                }
              }
            },
            plugins: [ChartDataLabels]
          });

          // populate legend DOM below canvas
          countryLegend.innerHTML = '';
          countryLabelsDynamic.forEach((lbl, idx) => {
            const swatch = document.createElement('div');
            swatch.className = 'flex items-center gap-2';
            swatch.innerHTML = `<span class="w-3 h-3 rounded-full" style="background:${countryColors[idx]}"></span><span>${lbl}</span>`;
            countryLegend.appendChild(swatch);
          });
        }

        // Prepare vehicle dataset
        const vehicleEntries = Object.entries(data.vehicleTypes || {}).sort((a,b) => b[1] - a[1]);
        const vehicleLabelsDynamic = vehicleEntries.map(v => v[0]);
        const vehicleValues = vehicleEntries.map(v => v[1]);
        const vehicleColors = ["#F97316","#EF4444","#FBBF24","#A855F7","#38BDF8","#06B6D4"];

        const vehicleCanvas = document.getElementById('vehicleChart');
        if (vehicleCanvas) {
          const existingVehicleChart = Chart.getChart(vehicleCanvas);
          if (existingVehicleChart) existingVehicleChart.destroy();
          if (vehicleChartInstance) vehicleChartInstance.destroy();

          // ensure a legend container exists beneath the canvas
          let vehicleLegend = vehicleCanvas.nextElementSibling;
          if (!vehicleLegend || !vehicleLegend.classList || !vehicleLegend.classList.contains('chart-legend')) {
            vehicleLegend = document.createElement('div');
            vehicleLegend.className = 'chart-legend mt-4 text-sm flex flex-wrap justify-center gap-3';
            vehicleCanvas.parentNode.insertBefore(vehicleLegend, vehicleCanvas.nextSibling);
          }

          vehicleChartInstance = new Chart(vehicleCanvas.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: vehicleLabelsDynamic,
              datasets: [{ data: vehicleValues, backgroundColor: vehicleColors.slice(0, vehicleLabelsDynamic.length), borderWidth: 0 }]
            },
            options: {
              cutout: '75%',
              animation: { duration: 800, easing: 'easeInOutCubic' },
              plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed}` } },
                datalabels: {
                  color: '#000',
                  formatter: (value, ctx) => {
                    const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                    const pct = Math.round((value / sum) * 100);
                    return pct + '%';
                  },
                  anchor: 'center',
                  align: 'center',
                  font: { weight: 'bold', size: 12 }
                }
              }
            },
            plugins: [ChartDataLabels]
          });

          // populate legend DOM below canvas
          vehicleLegend.innerHTML = '';
          vehicleLabelsDynamic.forEach((lbl, idx) => {
            const swatch = document.createElement('div');
            swatch.className = 'flex items-center gap-2';
            swatch.innerHTML = `<span class="w-3 h-3 rounded-full" style="background:${vehicleColors[idx]}"></span><span>${lbl}</span>`;
            vehicleLegend.appendChild(swatch);
          });
        }
      }

      // Initialize all charts with default data and wire visitor card handlers
      document.addEventListener('DOMContentLoaded', async () => {
        // wire visitor card click/keyboard handlers
        const cardEls = document.querySelectorAll('[data-period]');
        cardEls.forEach((card) => {
          const period = card.getAttribute('data-period');
          card.addEventListener('click', async () => {
            await loadDataForPeriod(period);
          });
          card.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              await loadDataForPeriod(period);
            }
          });
        });

  // initial load — load 'all' data but ensure monthly donuts populate from tour-guides-and-drivers
  await loadDataForPeriod('all');
  // populate monthly guides & drivers immediately
  try { await updateDonutCharts('month'); } catch (e) { console.warn('monthly donut prefill failed', e); }
      });

      const tabs = document.querySelectorAll("#tabs .tab-button");

      tabs.forEach((tab) => {
        tab.addEventListener("click", async () => {
          // Update tab styling
          tabs.forEach((t) => {
            t.classList.remove(
              "text-orange-500",
              "border-b-2",
              "border-orange-500"
            );
            t.classList.add("text-gray-400");
          });

          tab.classList.remove("text-gray-400");
          tab.classList.add(
            "text-orange-500",
            "border-b-2",
            "border-orange-500"
          );

          // Get period from tab text and load corresponding data
          const tabText = tab.textContent.trim().toLowerCase();
          let period = 'all';
          
          if (tabText.includes('today') || tabText.includes('өнөөдөр')) {
            period = 'today';
          } else if (tabText.includes('week') || tabText.includes('7 хоног')) {
            period = 'week';
          } else if (tabText.includes('month') || tabText.includes('1 сар')) {
            period = 'month';
          } else if (tabText.includes('year') || tabText.includes('жил')) {
            period = 'year';
          }

          // Load data for selected period
          await loadDataForPeriod(period);
        });
      });

      // Global chart instances
      let chart1Instance = null;
      let chart2Instance = null;
      let barChartInstance = null;

      // Function to fetch monthly tour guides & drivers statistics
      async function fetchDriverGuideStats(period = 'all') {
        try {
          // Use the tour-guides-and-drivers endpoint which provides aggregated guides/drivers
          const response = await fetch(`${API_BASE_URL}/tour-guides-and-drivers?period=${period}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error fetching tour-guides-and-drivers statistics:', error);
          // Return fallback data
          return { drivers: 600, guides: 200, total: 800 };
        }
      }

      // Function to fetch tour operator statistics
      async function fetchTourOperatorStats(period = 'all') {
        try {
          const response = await fetch(`${API_BASE_URL}/tour-operator-stats?period=${period}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error fetching tour operator statistics:', error);
          // Return fallback data if API fails
          return [
            { operator: "Nomadic Journeys", count: 120 },
            { operator: "Gobi Discovery", count: 95 },
            { operator: "Mongolia Quest", count: 80 },
            { operator: "Eternal Landscapes", count: 65 },
            { operator: "Steppe Adventures", count: 45 }
          ];
        }
      }

      // Function to fetch hourly visitor statistics from backend
      async function fetchHourlyStats(period = 'week') {
        try {
          const response = await fetch(`${API_BASE_URL}/visitor-stats/hourly?period=${period}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error fetching hourly visitor statistics:', error);
          // Return fallback data if API fails
          const fallbackData = [];
          const mockData = [0, 6, 11, 16, 22, 22, 33, 38, 22, 22, 18, 16, 16, 10, 9, 7, 2];
          for (let hour = 7; hour <= 23; hour++) {
            fallbackData.push({
              hour,
              totalVisitors: mockData[hour - 7] || 0,
              avgVisitors: mockData[hour - 7] || 0
            });
          }
          return fallbackData;
        }
      }

      // Donut Charts
      const createChart = (canvasId, data, chartInstance) => {
        const canvasEl = document.getElementById(canvasId);
        if (!canvasEl) return null;

        // Destroy any Chart.js instance attached directly to the canvas
        const existing = Chart.getChart(canvasEl);
        if (existing) existing.destroy();

        // Destroy provided instance handle
        if (chartInstance) chartInstance.destroy();

        // ensure legend container exists
        let legend = canvasEl.nextElementSibling;
        if (!legend || !legend.classList || !legend.classList.contains('chart-legend')) {
          legend = document.createElement('div');
          legend.className = 'chart-legend mt-4 text-sm flex flex-wrap justify-center gap-3';
          canvasEl.parentNode.insertBefore(legend, canvasEl.nextSibling);
        }

        const labels = ["Drivers", "Guides"];
        const sum = data.reduce((a,b) => a+b, 0) || 1;
        const percentData = data.map(v => Math.round((v / sum) * 100));

        const chart = new Chart(canvasEl.getContext('2d'), {
          type: "doughnut",
          data: {
            labels,
            datasets: [
              {
                data,
                backgroundColor: ["#f97316", "#3b82f6"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            cutout: "75%",
            responsive: true,
            animation: { duration: 800, easing: 'easeInOutCubic' },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
              datalabels: {
                color: '#000',
                formatter: (value, ctx) => {
                  const s = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                  return Math.round((value / s) * 100) + '%';
                },
                anchor: 'center',
                align: 'center',
                font: { weight: 'bold', size: 12 }
              }
            },
          },
          plugins: [ChartDataLabels]
        });

        // populate legend DOM below canvas
        legend.innerHTML = '';
        labels.forEach((lbl, idx) => {
          const sw = document.createElement('div');
          sw.className = 'flex items-center gap-2';
          sw.innerHTML = `<span class="w-3 h-3 rounded-full" style="background:${["#f97316","#3b82f6"][idx]}"></span><span>${lbl} (${percentData[idx]}%)</span>`;
          legend.appendChild(sw);
        });

        return chart;
      };

      // Function to update donut charts
      async function updateDonutCharts(period = 'all') {
        try {
          const stats = await fetchDriverGuideStats(period);
          
          // Update chart1 (individual counts)
          chart1Instance = createChart("chart1", [stats.drivers, stats.guides], chart1Instance);
          
          // Update chart2 (scaled up version for visual effect)
          const scaleFactor = 7.5; // To match original visual scale
          chart2Instance = createChart("chart2", [stats.drivers * scaleFactor, stats.guides * scaleFactor], chart2Instance);

          // Sync numeric placeholders if present
          const driversEl = document.getElementById('driverCountValue');
          const guidesEl = document.getElementById('guideCountValue');
          const driversElScaled = document.getElementById('driverCountValueScaled');
          const guidesElScaled = document.getElementById('guideCountValueScaled');
          const totalEl = document.getElementById('driverGuideTotal');
          const totalScaledEl = document.getElementById('driverGuideTotalScaled');
          if (driversEl) driversEl.textContent = String(stats.drivers || 0);
          if (guidesEl) guidesEl.textContent = String(stats.guides || 0);
          if (driversElScaled) driversElScaled.textContent = String(Math.round((stats.drivers || 0) * scaleFactor));
          if (guidesElScaled) guidesElScaled.textContent = String(Math.round((stats.guides || 0) * scaleFactor));
          if (totalEl) totalEl.textContent = String((stats.drivers || 0) + (stats.guides || 0));
          if (totalScaledEl) totalScaledEl.textContent = String(Math.round(((stats.drivers || 0) + (stats.guides || 0)) * scaleFactor));
          
        } catch (error) {
          console.error('Error updating donut charts:', error);
        }
      }

      // Function to update bar chart
      async function updateBarChart(period = 'all') {
        try {
          const operatorStats = await fetchTourOperatorStats(period);
          
          // Destroy existing chart if it exists
          if (barChartInstance) {
            barChartInstance.destroy();
          }
          
          const labels = operatorStats.map(item => item.operator);
          const data = operatorStats.map(item => item.count);
          
          barChartInstance = new Chart(document.getElementById("barChart"), {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Visitors",
                  data: data,
                  backgroundColor: "#4870B5",
                  borderRadius: 6,
                  barThickness: 20,
                },
              ],
            },
            options: {
              indexAxis: "y",
              plugins: {
                legend: { display: false },
              },
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: { stepSize: 20 },
                  grid: {
                    drawBorder: false,
                    color: "#e5e7eb",
                  },
                },
                y: {
                  grid: { display: false },
                },
              },
            },
          });
        } catch (error) {
          console.error('Error updating bar chart:', error);
        }
      }

      // Function to update Peak Visitor Chart
      let peakVisitorChartInstance = null;
      async function updatePeakVisitorChart(period = 'week') {
        try {
          const hourlyData = await fetchHourlyStats(period);
          
          // If the canvas for peak visitor chart is not present, skip creating/updating it
          const peakCanvas = document.getElementById("peakVisitorChart");
          if (!peakCanvas) {
            // destroy existing instance if present and then return
            if (peakVisitorChartInstance) {
              peakVisitorChartInstance.destroy();
              peakVisitorChartInstance = null;
            }
            return;
          }

          // Destroy existing chart if it exists
          if (peakVisitorChartInstance) {
            peakVisitorChartInstance.destroy();
          }

          // Format labels (7 AM to 11 PM)
          const labels = [];
          const data = [];

          (hourlyData || []).forEach(item => {
            const hour = item.hour;
            if (hour === 12) {
              labels.push("12 PM");
            } else if (hour < 12) {
              labels.push(`${hour} AM`);
            } else {
              labels.push(`${hour} PM`);
            }
            data.push(item.avgVisitors || 0);
          });

          const ctx1 = peakCanvas.getContext("2d");

          peakVisitorChartInstance = new Chart(ctx1, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Visitors",
                  data: data,
                  backgroundColor: "rgba(59, 130, 246, 0.8)", // Tailwind blue-500
                  borderRadius: 6,
                  barPercentage: 0.55,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  min: 0,
                  max: Math.max(...data, 50),
                  ticks: { stepSize: 10 },
                  grid: { borderDash: [5, 5], color: "#e5e7eb" }, // Tailwind gray-200
                },
                x: {
                  grid: { borderDash: [5, 5], color: "#e5e7eb" },
                },
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: "#1f2937", // dark tooltip
                  titleColor: "#fff",
                  bodyColor: "#fff",
                },
              },
            },
          });
        } catch (error) {
          console.error('Error updating peak visitor chart:', error);
        }
      }

      // visitorChart instance (dynamic) -------------------------------------------------
      let visitorChartInstance = null;

      // Fetch daily visitor stats from backend
      async function fetchDailyStats(period = 'week') {
        try {
          const resp = await fetch(`${API_BASE_URL}/daily-visitor-stats?period=${period}`);
          if (!resp.ok) throw new Error('daily-visitor-stats fetch failed');
          return await resp.json();
        } catch (error) {
          console.error('Error fetching daily visitor stats:', error);
          // fallback: synthesize 7-day mock
          const mock = [];
          const now = new Date();
          for (let i = 6; i >= 0; i--) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);
            mock.push({ date: d.toISOString(), totalVisitors: Math.floor(Math.random() * 200) + 20 });
          }
          return mock;
        }
      }

      // Update visitorChart with daily data
      async function updateVisitorChart(period = 'week') {
        try {
          const data = await fetchDailyStats(period);
          if (!data || !Array.isArray(data)) return;

          // Map to labels and values. Try common field names.
          const labels = data.map(item => {
            const dt = item.date ? new Date(item.date) : new Date(item.day || item._date || item.createdAt);
            return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
          });

          const values = data.map(item => {
            return (item.totalVisitors != null) ? item.totalVisitors : ((item.domesticVisitors || 0) + (item.internationalVisitors || 0));
          });

          const canvas = document.getElementById('visitorChart');
          if (!canvas) return;

          // destroy existing
          const existing = Chart.getChart(canvas);
          if (existing) existing.destroy();
          if (visitorChartInstance) visitorChartInstance.destroy();

          visitorChartInstance = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Daily Visitors',
                data: values,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245,158,11,0.08)',
                tension: 0.35,
                fill: true,
                pointRadius: 3,
                pointBackgroundColor: '#f59e0b'
              }]
            },
            options: {
              responsive: true,
              animation: { duration: 800, easing: 'easeInOutCubic' },
              scales: {
                y: { beginAtZero: true, grid: { color: '#d1d5db' } },
                x: { grid: { color: '#d1d5db' } }
              },
              plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
            }
          });
        } catch (error) {
          console.error('Error updating visitor chart:', error);
        }
      }
    </script>

    <!-- Peak Visitor Chart - Now loaded dynamically -->
    <script>
     
    </script>


    <!-- Vehicle Statistics -->
    <script>
      const countryLabels = [
        "China",
        "Russia",
        "South",
        "Others",
        "Kazakhstan",
        "Japan",
        "USA",
      ];
      const countryData = [31, 24, 22, 14, 4, 3, 2];

      const countryCanvas = document.getElementById("countryChart");
      if (countryCanvas) {
        const countryCtx = countryCanvas.getContext("2d");

        // create legend container if missing
        let countryLegend = countryCanvas.nextElementSibling;
        if (!countryLegend || !countryLegend.classList || !countryLegend.classList.contains('chart-legend')) {
          countryLegend = document.createElement('div');
          countryLegend.className = 'chart-legend mt-4 text-sm flex flex-wrap justify-center gap-3';
          countryCanvas.parentNode.insertBefore(countryLegend, countryCanvas.nextSibling);
        }

        const sum = countryData.reduce((a,b) => a+b, 0) || 1;
        const percentData = countryData.map(v => Math.round((v / sum) * 100));

        if (countryChartInstance) countryChartInstance.destroy();
        countryChartInstance = new Chart(countryCtx, {
        type: "doughnut",
        data: {
          labels: countryLabels,
          datasets: [
            {
              data: countryData,
              backgroundColor: [
                "#F97316",
                "#EF4444",
                "#FBBF24",
                "#22D3EE",
                "#0EA5E9",
                "#A855F7",
                "#EC4899",
              ],
              borderWidth: 0,
            },
          ],
        },
        options: {
          cutout: "80%",
          animation: { duration: 800, easing: 'easeInOutCubic' },
          plugins: {
            legend: { display: false },
            datalabels: {
              color: "#000",
              font: {
                size: 12,
                weight: "bold",
              },
              formatter: (value, ctx) => {
                const s = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                return Math.round((value / s) * 100) + '%';
              },
              anchor: "center",
              align: "center",
            },
            tooltip: {
              callbacks: {
                label: (context) =>
                  `${countryLabels[context.dataIndex]}: ${context.parsed}`,
              },
            },
          },
        },
        plugins: [
          ChartDataLabels,
          {
            id: "countryLabelsOutside",
            afterDatasetsDraw(chart) {
              const ctx = chart.ctx;
              const meta = chart.getDatasetMeta(0);
              const dataset = chart.data.datasets[0];
              meta.data.forEach((element, index) => {
                const angle = (element.startAngle + element.endAngle) / 2;
                const radius = element.outerRadius + 20;
                const x = chart.width / 2 + Math.cos(angle) * radius;
                const y = chart.height / 2 + Math.sin(angle) * radius;
                ctx.save();
                ctx.fillStyle = "#000";
                ctx.font = "12px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(countryLabels[index], x, y);
                ctx.restore();
              });
            },
          },
        ],
        });

        // populate legend DOM below canvas
        countryLegend.innerHTML = '';
        countryLabels.forEach((lbl, idx) => {
          const swatch = document.createElement('div');
          swatch.className = 'flex items-center gap-2';
          swatch.innerHTML = `<span class="w-3 h-3 rounded-full" style="background:${["#F97316","#EF4444","#FBBF24","#22D3EE","#0EA5E9","#A855F7","#EC4899"][idx]}"></span><span>${lbl} (${percentData[idx]}%)</span>`;
          countryLegend.appendChild(swatch);
        });
      }

      const vehicleLabels = [
        "Minibus",
        "4WD SUV",
        "Bus",
        "Crossover",
        "Compact car",
        "Motorcycle",
      ];
      const vehicleData = [30, 25, 20, 15, 5, 5];
      const vehicleIcons = {
        Minibus: "🚐",
        "4WD SUV": "🚙",
        Bus: "🚌",
        Crossover: "🛻",
        "Compact car": "🚗",
        Motorcycle: "🏍️",
      };

      const vehicleCanvas = document.getElementById("vehicleChart");
      if (vehicleCanvas) {
        const vehicleCtx = vehicleCanvas.getContext("2d");

        // create legend container if missing
        let vehicleLegend = vehicleCanvas.nextElementSibling;
        if (!vehicleLegend || !vehicleLegend.classList || !vehicleLegend.classList.contains('chart-legend')) {
          vehicleLegend = document.createElement('div');
          vehicleLegend.className = 'chart-legend mt-4 text-sm flex flex-wrap justify-center gap-3';
          vehicleCanvas.parentNode.insertBefore(vehicleLegend, vehicleCanvas.nextSibling);
        }

        const sumV = vehicleData.reduce((a,b) => a+b, 0) || 1;
        const percentV = vehicleData.map(v => Math.round((v / sumV) * 100));

        if (vehicleChartInstance) vehicleChartInstance.destroy();
        vehicleChartInstance = new Chart(vehicleCtx, {
        type: "doughnut",
        data: {
          labels: vehicleLabels,
          datasets: [
            {
              data: vehicleData,
              backgroundColor: [
                "#F97316",
                "#EF4444",
                "#FBBF24",
                "#A855F7",
                "#38BDF8",
                "#06B6D4",
              ],
              borderWidth: 0,
            },
          ],
        },
        options: {
          cutout: "80%",
          animation: { duration: 800, easing: 'easeInOutCubic' },
          plugins: {
            legend: { display: false },
            datalabels: {
              color: "#000",
              font: {
                size: 12,
                weight: "bold",
              },
              formatter: (value, ctx) => {
                const s = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                return Math.round((value / s) * 100) + '%';
              },
              anchor: "center",
              align: "center",
            },
            tooltip: {
              callbacks: {
                label: (context) =>
                  `${vehicleIcons[vehicleLabels[context.dataIndex]]} ${
                    vehicleLabels[context.dataIndex]
                  }: ${context.parsed}`,
              },
            },
          },
        },
        plugins: [
          ChartDataLabels,
          {
            id: "vehicleLabelsOutside",
            afterDatasetsDraw(chart) {
              const ctx = chart.ctx;
              const meta = chart.getDatasetMeta(0);
              meta.data.forEach((element, index) => {
                const angle = (element.startAngle + element.endAngle) / 2;
                const radius = element.outerRadius + 20;
                const x = chart.width / 2 + Math.cos(angle) * radius;
                const y = chart.height / 2 + Math.sin(angle) * radius;
                ctx.save();
                ctx.fillStyle = "#000";
                ctx.font = "12px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(
                  `${vehicleIcons[vehicleLabels[index]]} ${
                    vehicleLabels[index]
                  }`,
                  x,
                  y
                );
                ctx.restore();
              });
            },
          },
          {
            id: "centerImage",
            afterDraw(chart) {
              const image = new Image();
              image.src = "images/bus.png"; // <-- Өөрийн зурган замаа оруул
              image.onload = () => {
                const ctx = chart.ctx;
                const size = 50; // Зурагны хэмжээ
                const x = chart.width / 2 - size / 2;
                const y = chart.height / 2 - size / 2;
                ctx.save();
                ctx.drawImage(image, x, y, size, size);
                ctx.restore();
              };
            },
          },
        ],
        });

        // populate legend DOM below canvas
        vehicleLegend.innerHTML = '';
        vehicleLabels.forEach((lbl, idx) => {
          const swatch = document.createElement('div');
          swatch.className = 'flex items-center gap-2';
          swatch.innerHTML = `<span class="w-3 h-3 rounded-full" style="background:${["#F97316","#EF4444","#FBBF24","#A855F7","#38BDF8","#06B6D4"][idx]}"></span><span>${lbl} (${percentV[idx]}%)</span>`;
          vehicleLegend.appendChild(swatch);
        });
      }
    </script>
    <script src="footer-loader.js"></script>
  </body>
</html>
